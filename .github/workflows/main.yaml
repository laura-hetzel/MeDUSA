name: Docker Image CI

env:
  DOCKER_TAG: v4

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  docker_build_amd:
    runs-on: ubuntu-latest
    steps:
    - name: Check out the repo
      uses: actions/checkout@v4
    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USER }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
    - name: Build Docker AMD
      run: docker build . -f Dockerfile -t thefollyllama/medusa:${DOCKER_TAG}-amd64  --platform linux/amd64 --provenance=FALSE
    - name: Push image AMD
      run: docker push thefollyllama/medusa:${DOCKER_TAG}-amd64
      if: github.event_name != 'pull_request'

  docker_build_arm:
    runs-on: ubuntu-latest
    steps:
    - name: Check out the repo
      uses: actions/checkout@v4
    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USER }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
    - name: Build Docker AMD
      run: docker build . -f Dockerfile -t thefollyllama/medusa:${DOCKER_TAG}-arm64  --platform linux/amd64 --provenance=FALSE
    - name: Push image AMD
      run: docker push thefollyllama/medusa:${DOCKER_TAG}-arm64
      if: github.event_name != 'pull_request'

  docker_create_manifest:
    needs: [docker_build_amd, docker_build_arm]
    runs-on: ubuntu-latest
    steps:
    - name: create_manifest
      run: |
        docker manifest create thefollyllama/medusa:${DOCKER_TAG}  --amend thefollyllama/medusa:${DOCKER_TAG}-arm64  --amend thefollyllama/medusa:${DOCKER_TAG}-amd64
        docker manifest push thefollyllama/medusa:${DOCKER_TAG}
      if: github.event_name != 'pull_request'
