---
title: "Alignment"
author:
- name: Pascal Maas
  affiliation: >
   Leiden Academic Centre for Drug Research, 
   Leiden University, Netherlands
  email: p.maas@lacdr.leidenuniv.nl
  
date: "`r Sys.Date()`"
output: 
  html_document:
      theme: united
      highlight: tango
vignette: >
  %\VignetteIndexEntry{Alignment}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval = FALSE)
suppressPackageStartupMessages(library(sumR))
```

### Spectra Alignment

After we've detected our peaks, we need to identify which peaks should be considered equal across spectra within a cell. We use the function `spectraAlignment()` to align masses with a given `ppm` (Defaults to `5`). Alignment can be done using either the `binning` (default), `clustering`, or `density` method. While chromatography cannot be used to identify compounds, we do expect to find a compound multiple times across scans. This is adjusted using the `nPeaks` parameter. Here, we set the value of nPeaks to `5` to discard peaks that are likely to be false positives and should not be considered novel compounds:

```{r spectraAlignment}
spectra <- spectraAlignment(peaks,
                            method = "binning",
                            ppm = 5,
                            nPeaks = 5)
```

```{r showAlignment, echo = FALSE}
knitr::kable(head(as.data.frame(spectra)[, -which(colnames(spectra) == "peakidx")]), caption = "Compounds aligned across spectra")
```

#### Inspecting Spectra Shifts

To inspect if the alignment did not over-correct, we can use the function `spectraShiftPlot()`. It shows the difference between the original mass and the mass shift after alignment. Changing the parameters `nPeaks` and `ppm` of the `spectraAlignment()` function will affect this mass shift. Since the alignment is based on ppm, we expect this mass shift to increase with increasing masses. The `cell` parameter either takes the cell name as defined in the metadata or the cell number.

```{r spectraShift}
spectraShiftPlot(spectra, cell = 1)
```

### Cell Alignment

After the spectra within cells are aligned, we repeat the alignment between cells. Our arguments are similar to `spectraAlignment()`, however, the function `cellAlignment` returns a `SummarizedExperiment` object instead. Since this object is used throughout the sumR workflow, you can read more about interacting with a SummarizedExperiment object [here](https://bioconductor.org/help/course-materials/2019/BSS2019/04_Practical_CoreApproachesInBioconductor.html).

Other differences include the `nCells` parameter instead of `nPeaks`, which sets the threshold for the minimum number of cells a compound should be found. the nCells parameter is highly dependent on the experimental design, as it affects the biological variation between cells. The metadata of each cell, `cellData`, can be set here as well. Omitting this will result in a warning, as it is necessary to continue the post-processing pipeline. Lastly, the `phenotype` parameter can be set and refers to the column in the cellData that will be used for statistical tests and modelling.

```{r cellBinning}
exp <- cellAlignment(
  spectra, 
  method = "binning", 
  ppm = 5, 
  nCells = 10,
  cellData = df,
  phenotype = "Treatment"
)
```

#### Inspecting Cell Shifts

We can inspect the mass shift between cells that occured during alignment.

```{r cellShift}
cellShiftPlot(exp)
```

# SessionInfo
```{r, echo = FALSE}
if (requireNamespace("devtools", quietly = TRUE)) {
  devtools::session_info("attached")
}
```
