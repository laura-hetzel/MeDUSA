---
title: "Usage"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Usage}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

_This package is under heavy development. Please do not use this package for actual reserach._

```{r setup, eval = T}
suppressWarnings(suppressPackageStartupMessages(library(sumR)))
```

First we load up some example data. Here we have 4 injection of which 1 is a blank sample, all with negative polarity. These files have spectra which are combined together and centroided. 
```{r files, eval = T}
dir <- file.path(r"(C:\Users\pmaas\Downloads\stem_cell_blank_cell_samples\stem_cell_blank_cell_samples)")
```

## Converting vendor format
To convert your vendor to mzML, we can use the `rawToMzml` function. 

```{r eval = F}
files <- rawToMzml(dir, output = file.path(getwd(), "test2"), rt = c(60, 420))
```

## Defining Metadata

```{r, eval = T}
df <- openxlsx::read.xlsx(r"(C:\Users\pmaas\Downloads\2021_09_11_pilot study sampling.xlsx)", 1)
f <- list.files(dir, full.names = T, pattern = ".mzML")
type <- rep("SAMPLE", length(f))
type[grep("blank", basename(f))] <- "BLANK"

df2 <- data.frame(File = f, Type = type, Sample.number = as.integer(stringr::str_extract(basename(f), "[0-9]{3}")))
df <- dplyr::full_join(df, df2, "Sample.number")
df <- df[!is.na(df$File), ]
print(head(df))
```

## Peak picking
Cells measured using DI-MS can be analyzed using the spectrum-based peak picking. 
```{r, eval = T}
exp <- peakPicking(df$File, SNR = 0.5) %>%
  binSpectra(npeaks = 5) %>%
  binCells(cellData = df, phenotype = "na√Øve.vs.differentiated")
```

## Postprocessing

* Blank substraction
* Imputation
* Isotope detection
* Variable feature filtering

```{r, eval = T}
exp <- exp %>%
  blankSubstraction() %>%
  imputation() %>%
  isotopeTagging() %>%
  keepVariableFeatures(top = 100)
```

## Modelling & Statistics

* Shapiro test for normality
* Levene test for variance
* Welch test for significant difference
* Fold change for log difference
* Model generation to retrieve feature importance

```{r, eval = T}
exp <- exp %>%
  shapiroTest() %>%
  leveneTest() %>%
  welchTest() %>%
  foldChange() %>%
  generateModel(modelName = "rf", seed = 42) %>%
  generateModel(modelName = "glmnet", seed = 42)
```


## Model Assessment
```{r assessment}
print(model(exp, "rf")$confMatrix)
print(model(exp, "glmnet")$confMatrix)
```

## Plot
```{r pca, eval = T, fig.width=6}
samplePCA(exp)
compoundPCA(exp)
screePCA(exp)
```

```{r CV, eval = T, fig.width=6}
plotCrossValidation(exp, "rf")
plotCrossValidation(exp, "glmnet") 
```

## SessionInfo

```{r sessionInfo}
sessionInfo()
```
