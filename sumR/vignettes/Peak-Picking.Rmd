---
title: "Peak Picking"
author:
- name: Pascal Maas
  affiliation: >
   Leiden Academic Centre for Drug Research, 
   Leiden University, Netherlands
  email: p.maas@lacdr.leidenuniv.nl
  
date: "`r Sys.Date()`"
output: 
  html_document:
      theme: united
      highlight: tango
vignette: >
  %\VignetteIndexEntry{Peak Picking}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval = FALSE)
suppressPackageStartupMessages(library(sumR))
```

### Extracting peaks

Peaks can be extracted from the mzML file using the `extractPeaks()` function. This function converts profile-mode data to centroid-mode by doing the following steps:

1.  Extract scans within a massWindow (e.g. a scan of 200-350 dalton has a massWindow of 150 dalton). Defaults to `c(0, Inf)` which extracts everything.
2.  Extract scans of either positive (+) or negative (-) polarity.
3.  Smooth these scans using a Savitzky-Golay filter
4.  Centroid by picking local maxima

By setting `cores` to any value higher than 1, each scan is centroided in parallel using that amount of cores. The function returns a list of data frames, one for each cell.

```{r prepareScans}
peaks <- extractPeaks(
  files, 
  polarity = "+", 
  cores = 8
)
```

We can plot the result of this function using a `spectrumPlot`. This plots the centroided peaks of a single scan by providing the filename and a scan number:

```{r spectrumPlot}
spectrumPlot(peaks, file = 1, scan = 1)
```

### Filtering Peaks

After inspection, we can filter noisy peaks by a minimum intensity value using the `peakFilter()` function. It returns a similar list of data frames, but only peaks with at least the given intensity are kept. We can view the difference by plotting the results in a `spectrumPlot`:

```{r peakPlot}
peakFilter(peaks, intensity = 1e3) %>%
  spectrumPlot(file = 1, scan = 1)
```

To save the peaks with our chosen intensity filter, we can override the results in the `peaks` variable.

```{r peakFilter}
peaks <- peakFilter(peaks, intensity = 1e3)
```
