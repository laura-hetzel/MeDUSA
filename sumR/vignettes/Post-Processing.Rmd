---
title: "Post-Processing"
author:
- name: Pascal Maas
  affiliation: >
   Leiden Academic Centre for Drug Research, 
   Leiden University, Netherlands
  email: p.maas@lacdr.leidenuniv.nl
  
date: "`r Sys.Date()`"
output: 
  html_document:
      theme: united
      highlight: tango
vignette: >
  %\VignetteIndexEntry{Post-Processing}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval = FALSE)
suppressPackageStartupMessages(library(sumR))
```
## Post-processing

With aligned features across cells, the pre-processing is complete. However, not all aligned features are actually novel compounds. This is due to artifacts, fragments, isotopes, and other non-biological compounds. The following functions are part of the post-processing pipeline in sumR to remove these unwanted features. All these functions are optional (and can be executed in any order), but are recommended for most uses.

### Blank substracton

When Blank samples are measured, these can be used to filter any features. `blankThresh` indicates the fold-change needed to exceed for a sample to be kept. By default, samples must have an intensity of at least 5x higher than the blank samples in order to be kept. This ensures that noisy peaks are removed. The `nSamples` parameter determines the number of samples that the blank threshold should exceed in order for a compound to be removed. The default for nSamples is infinite, thus no features will be removed. To remove the blank samples after filtering compounds, set the `removeBlanks` parameter to TRUE (the default)

```{r Blanks}
exp <- blankSubstraction(exp, blankThresh = 5, nSamples = 10, removeBlanks = TRUE)
```

### Mass Defect Filter

As described by [McMillan et al.](10.1186/s13321-016-0156-0), calculating the mass defect can be used to identify potential salt clusters and other non-biological compounds. This is implemented in the `massDefectFilter` which can plot the mass versus mass defect.

```{r}
exp <- massDefectFilter(exp, plot = TRUE)
```

### Missing value imputation

Due to the dropout effect, single cell datasets can contain over 50% of NA values which will need to be imputed for statistical analysis. sumR currently has two methods for imputation, determined by the parameter `method`. This parameter can either be set to `"noise"` or `"saver"`. The former is a noise-based random imputation method. It will generate a random number between 1 and the value of `noise`, which defaults to 100. The saver method is model-based that assumes a poisson distribution and will generate values that are similar to highly correlated cells.

```{r imoputation}
exp <- imputation(exp, method = "noise", noise = 100, seed = 42)
```

### Isotope identification

When interested in novel compounds, isotopes and adducts are a source of unwanted features. The function `isotopeTagging()` can detect isotopes and adducts using known ratios of mass and intensities of atoms. Calling this function will store detailed results about isotopes and adducts in the `rowData` slot of the object.

```{r isotopes}
exp <- isotopeTagging(exp, corr = 0.8)
```

### Fragment filtering

Another source of unwanted features is fragmented compounds. These are features that show highly correlated intensity values and are generally removed during post-processing. Here we use the function `fragmentFilter()` to remove highly correlated features. The threshold of correlation can be determined by the parameter `corr`, which is set here at 95%. Available methods for fragment filtering are `pearson` and `spearman`. Here spearman correlation is used, as for datasets with a lot of imputed values pearson correlation might overestimate the correlation.

```{r fragments}
exp <- fragmentFilter(exp, method = "spearman", corr = 0.95)
```
